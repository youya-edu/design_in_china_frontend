<template>
  <div>
    <MInputMessageLabel
      type="email"
      :placeholder="$t('email')"
      v-model="userKeyInfo.email"
      @keyup="checkEmail()"
      :hasError="emailCheckResult.hasError"
      :message="emailCheckResult.message"
    />
    <MInputMessageLabel
      type="username"
      :placeholder="$t('username')"
      v-model="userKeyInfo.username"
      :hasError="usernameCheckResult.hasError"
      :message="usernameCheckResult.message"
      @keyup="checkUsername()"
    />
    <MInputMessageLabel
      type="password"
      :placeholder="$t('password')"
      v-model="userKeyInfo.password"
    />
    <button
      @click="signup(userKeyInfo)"
      class="w-full px-4 py-2 mt-6 rounded-md text-lg font-semibold text-white transition-colors duration-300 shadow"
      :disabled="!allValid"
      :class="[allValid ? buttonEnabled : buttonDisabled]"
    >
      {{ $t("sign_up") }}
    </button>
  </div>
</template>

<script lang="ts">
import { defineComponent } from "vue";
import { mapActions } from "vuex";
import { UserKeyInfo, validateEmail, check } from "@/domain/user";
import { modules } from "@/store/constants";
import { actions } from "@/store/user/constants";
import { MInputMessageLabel } from "@/components/molecules";
import { lodash } from "@/utils/lib";

export default defineComponent({
  components: { MInputMessageLabel },
  data() {
    return {
      userKeyInfo: {
        email: "",
        username: "",
        password: "",
      } as UserKeyInfo,
      emailCheckResult: {
        hasError: false,
        message: {
          type: "error",
          show: false,
          content: "不是有效的邮箱格式",
        },
      },
      usernameCheckResult: {
        hasError: false,
        message: {
          type: "error",
          show: false,
          content: "用户名已被注册",
        },
      },
      buttonEnabled: "bg-gray-700 hover:bg-gray-800 focus:outline-none",
      buttonDisabled: "bg-gray-300",
    };
  },
  methods: {
    ...mapActions(modules.USERS, [actions.LOGIN, actions.SIGNUP]),
    // eslint-disable-next-line
    checkEmail: lodash.debounce(async function (this: any) {
      if (this.userKeyInfo.email) {
        try {
          const emailFormatOk = validateEmail(this.userKeyInfo.email);
          const emailNotExisted = await check("check_email", this.userKeyInfo);
          if (!emailFormatOk) {
            this.emailCheckResult.hasError = true;
            this.emailCheckResult.message.type = "error";
            this.emailCheckResult.message.show = true;
            this.emailCheckResult.message.content = "不是有效的邮箱格式";
          } else if (!emailNotExisted) {
            this.emailCheckResult.hasError = true;
            this.emailCheckResult.message.type = "error";
            this.emailCheckResult.message.show = true;
            this.emailCheckResult.message.content = "邮箱已被注册";
          } else {
            this.emailCheckResult.hasError = false;
            this.emailCheckResult.message.type = "success";
            this.emailCheckResult.message.show = true;
            this.emailCheckResult.message.content = "邮箱可使用";
          }
        } catch (err) {
          console.error(err);
        }
      } else {
        this.emailCheckResult.hasError = false;
        this.emailCheckResult.message.show = false;
      }
    }, 300),
    // eslint-disable-next-line
    checkUsername: lodash.debounce(async function (this: any) {
      if (this.userKeyInfo.username) {
        this.usernameCheckResult.message.show = true;
        try {
          const usernameNotExisted = await check(
            "check_username",
            this.userKeyInfo
          );
          if (!usernameNotExisted) {
            this.usernameCheckResult.hasError = true;
            this.usernameCheckResult.message.type = "error";
            this.usernameCheckResult.message.content = "用户名已被注册";
          } else {
            this.usernameCheckResult.hasError = false;
            this.usernameCheckResult.message.type = "success";
            this.usernameCheckResult.message.content = "用户名可使用";
          }
        } catch (err) {
          console.error(err);
        }
      } else {
        this.usernameCheckResult.hasError = false;
        this.usernameCheckResult.message.show = false;
      }
    }, 300),
  },
  computed: {
    allValid(): boolean {
      return (
        this.userKeyInfo.email !== "" &&
        !this.emailCheckResult.hasError &&
        this.userKeyInfo.username !== "" &&
        !this.usernameCheckResult.hasError
      );
    },
  },
});
</script>
